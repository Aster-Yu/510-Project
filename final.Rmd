---
title: "Final Project_Survival Analysis"
output:
  pdf_document:
    highlight: haddock
    keep_tex: no
    number_sections: no
geometry: margin = 0.5in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = F,
  message = F,
  highlight = TRUE)


chunk_hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- chunk_hook(x, options)
  paste0("\\linespread{1}\n", x, "\n\n\\linespread{1.5}")
})

```

# 1. Survival Analysis
## (a) Data Exploration and Pre-processing
```{r}
# Load the survival package
library(survival)
library(dplyr)

# Load the pbcseq data set
data(pbc, package="survival")

# Check the structure of the data
str(pbcseq)
```

The data has 1945 observations and 19 variables

The variables are:

- id:	case number

- age:	in years

- sex:	m/f

- trt:	1/2/NA for D-penicillmain, placebo, not randomised

- time:	number of days between registration and the earlier of death,transplantion, or study analysis in July, 1986

- status:	status at endpoint, 0/1/2 for censored, transplant, dead

- day:	number of days between enrollment and this visit date all measurements below refer to this date

- albumin:	serum albumin (mg/dl)

- alk.phos:	alkaline phosphotase (U/liter)

- ascites:	presence of ascites

- ast:	aspartate aminotransferase, once called SGOT (U/ml)

- bili:	serum bilirunbin (mg/dl)

- chol:	serum cholesterol (mg/dl)

- copper:	urine copper (ug/day)

- edema:	0 no edema, 0.5 untreated or successfully treated 1 edema despite diuretic therapy

- hepato:	presence of hepatomegaly or enlarged liver

- platelet:	platelet count

- protime:	standardised blood clotting time

- spiders:	blood vessel malformations in the skin

- stage:	histologic stage of disease (needs biopsy)

- trig:	triglycerides (mg/dl)

```{r}
# Check the summary statistics of the data
summary(pbcseq)
```

The summary shows that there are some **missing values** in some variables.

The mean age is **49.26** years, the mean futime is **2941** days, and the mean bili is **3.672 mg/dl**.

The majority of the patients are female (87.81%), and most of them received D-penicillamine (50.28%).

The status variable has 3 levels: **0 (censored), 1 (transplanted), and 2 (dead)**.

The other variables are either binary or continuous.

## (b) Creating A Survival Object

Create a survival object from the data using the `Surv function`.

The first argument is the time variable, the second argument is the censoring variable.

The censoring variable is status, where 0 means censored and 1 or 2 means event.

I need to convert status to a binary variable, where 0 means censored and 1 means event.

```{r}
# We can use the ifelse function to do this
S <- Surv(pbcseq$day, pbcseq$futime, ifelse(pbcseq$status == 0, 0, 1))

# Check the structure of the survival object
str(S)
```

- The survival object is a matrix with **1945** rows and **3** columns.

- The first column is the time variable, the second column is the censoring variable.

- The censoring variable is a factor with levels **0 (censored) and 1 (event)**.

## (c)The Kaplan-Meier Estimator

### i. The Kaplan-Meier Estimator is a simple estimator that estimates the survival function $\begin{aligned}S_{X}(t)=\mathbb{P}(X>t)=1-F_{X}(t)\end{aligned}$ of the random variable X, time to a specific event. In case when no censoring exists in data, what is the relationship between the Kaplan-Meier estimator and the so-called empirical distribution function of X?

A: When there is no censoring in the data, the Kaplan-Meier estimator is equivalent to the empirical distribution function of X
The empirical distribution function of X is defined as $F_X(t) = n_t / n$, where $n_t$ is the number of observations with $X <= t$ and $n$ is the total number of observations.
The Kaplan-Meier estimator of the survival function is defined as $S_X(t) = Product_{i: t_i <= t} (1 - d_i / n_i)$, where $t_i$ are the distinct event times, $d_i$ are the number of events at time $t_i$, and $n_i$ are the number of subjects at risk just before time $t_i$
When there is no censoring, $d_i = n_t - n_{t-1}$ and $n_i = n - n_{t-1}$, where $n_{t-1}$ is the number of observations with $X < t_i$
Therefore, the Kaplan-Meier estimator can be simplified as $$S_X(t) = Product_{i: t_i <= t} (1 - (n_t - n_{t-1}) / (n - n_{t-1})) = Product_{i: t_i <= t} (n - n_t) / (n - n_{t-1}) = (n - n_t) / n = 1 - F_X(t)$$.

### ii. Build the Kaplan-Meier estimator for each level of the covariates drug (trt) and sex Survfit and plot the estimator for all of the levels of each covariate on the same figure. The horizontal axis in the Kaplan-Meier estimate is time. Times in the dataset are in days. Convert them to years for clarity.

A: 
To fit the Kaplan-Meier estimator for each covariate level, the `survfit` function is employed. This function requires two arguments: the survival object and the grouping variable. The latter can be specified using formula notation.

The `conf.type` argument allows me to choose the type of confidence interval for the estimator. Although the default setting is “log”, which provides log-transformed confidence intervals, other options include “plain”, “log-log”, and “none”. For the sake of simplicity, I will use the “plain” option in this instance. 

```{r fig.width = 10, fig.height = 8}
# Creating Surv in Years
S_year <- Surv(pbcseq$day/365, pbcseq$futime/365, ifelse(pbcseq$status == 0, 0, 1))


# Plotting survival analysis of trt and sex stratification.
km_drug <- survfit(S_year ~ pbcseq$trt)
km_sex <- survfit(S_year ~ pbcseq$sex)
plot(km_drug, main = "Kaplan-Meier Estimates", xlab = "Time in Years", ylab = "Survival Probability", 
     col = c("blue", "red"), lty = c(1,1), ylim = c(0, 1))
lines(km_sex, col = c("green", "purple"), lty = c(2,2))
legend(x = 0.2, y = 0.2, legend = c("Drug: Placebo", "Drug: D-penicillamine", "Sex: Male", "Sex: Female"), 
       col = c("blue", "red", "green", "purple"), lty = c(1, 1, 2, 2), bty = "n", cex = 0.8)
```

- Survival probability over time? Drops for all. 
- D-penicillamine outperforms Placebo. 
- Females survive more than males.

### iii. Create a new survival object for right censored data. `S2 = Surv(data$futime, data$status)`. The first argument is follow-up time and the second argument is the status. Using the survdiff function, determine whether sex and drug have significantly different Kaplan-Meier survival functions. Explain the log-rank test and its relationship with the X^2^ test used to test the difference. Test at a = 0.05.

A: The `survdiff` function is utilized to test if sex and drug have significantly different Kaplan-Meier survival functions. This function requires two arguments: the survival object and the grouping variable, which can be specified using formula notation.

The default test employed is the log-rank test, comparing the observed and expected numbers of events across groups. The test statistic is calculated as the sum of squared differences divided by their variances, following a chi-squared distribution with degrees of freedom equal to the number of groups minus one. The `pchisq` function can be used to compute the p-value of the test.

While the log-rank test is the default, other tests such as the Wilcoxon test (rho = 1) or the Tarone-Ware test (rho = 0.5) can be specified using the rho argument. However, in this instance, we will stick with the default log-rank test. This explanation is concise and suitable for a university-level audience.

```{r}
S2 <- Surv(pbcseq$futime, ifelse(pbcseq$status == 0, 0, 1))
km_test <- survdiff(S2 ~ pbcseq$trt + pbcseq$sex)
print(km_test)
```

In my output, four groups are compared:

- Group 1: Patients treated with placebo (trt=0) and are male (sex=m)
- Group 2: Patients treated with placebo (trt=0) and are female (sex=f)
- Group 3: Patients treated with D-penicillamine (trt=1) and are male (sex=m)
- Group 4: Patients treated with D-penicillamine (trt=1) and are female (sex=f)

For each group, the output provides:

- N: The number of subjects in the group.
- Observed: The number of observed events (deaths, in this case).
- Expected: The number of events expected if the null hypothesis were true.
- (O-E)^2/E: The contribution of each group to the chi-square statistic.
- (O-E)^2/V: The contribution of each group to the chi-square statistic, taking into account the correlation between groups.

The Chisq value (57.2) is the test statistic, which follows a chi-square distribution. The degrees of freedom (df) is 3 (the number of groups minus 1). The p-value is the probability of observing a test statistic as extreme as the one calculated (or more so) under the null hypothesis.

In this output, the p-value is extremely small (2e-12), which means that the null hypothesis (that there’s no difference between the survival curves of the four groups) can be rejected at a significance level of 0.05. This suggests that there is a significant difference in survival between the four groups.

## (d) Cox Proportional Hazard Model

A: 
- i. Hazard function, aka failure rate or intensity function, is $h_X(t) = \lim_{\delta t \to 0} P(t \leq X < t + \delta t | X \geq t) / \delta t$. It's the instantaneous event rate at time t, given survival until then.

- ii. Cumulative hazard function, $H_X(t) = \int_{0}^{t} h_X(u) du$, is the total risk up to time t.

- iii. Survival function, $S_X(t) = P(X > t) = 1 - F_X(t)$, is the survival probability beyond time t. It can be derived from hazard or cumulative hazard function as $S_X(t) = \exp(-H_X(t)) = \exp(-\int_{0}^{t} h_X(u) du)$.

- iv. Cox regression estimates proportional hazards via a model $h_X(t | Z) = h_0(t) \exp(\beta_1 Z_1 + \beta_2 Z_2 + … + \beta_p Z_p)$. It assumes hazard function is a product of a time-dependent baseline hazard, $h_0(t)$, and an exponential function of time-independent covariates, $Z_1, Z_2, …, Z_p$. Coefficients, $\beta_1, \beta_2, …, \beta_p$, are estimated using partial likelihood. The model can handle time-varying covariates but assumes constant coefficients over time. It's used for testing covariates, estimating hazard ratios, and predicting survival probabilities.

## (e) Make yourself familiar with the concept of a hazard function, a cumulative hazard function, and their relationship with the survival function. Cox regression is a method to estimate proportional hazards using a regression model that is fitted using Maximum Likelihood Estimation. This model can be time-varying. All covariates in this dataset other than sex and drug (trt) are time-varying, so we will have a time-varying model. Note that coefficients are time invariant.

### i. We will use log of the two covariates alkaline phosphate and platelet. Perform the conversion.

```{r}
# Use the log function to take the natural logarithm of the two covariates
# Assign the results to new variables log.alk.phos and log.platelet
pbcseq$alk.phos <- log(pbcseq$alk.phos)
pbcseq$platelet <- log(pbcseq$platelet)
```

### ii. Impute the missing values in the data with the mean of each continuous covariate or the mode of each categorical covariate.
- Use the `is.na` function to identify the missing values in the data
- Use the `mean` function to calculate the mean of each continuous covariate
- Use the `which.max` function to find the index of the maximum value of the table function, which gives the frequency of each level of a categorical covariate
- Use the `names` function to extract the name of the level corresponding to the index
- Use the `ifelse` function to replace the missing values with the mean or mode

```{r}
pbcseq <- pbcseq %>%
  mutate_if(is.numeric, function(x) ifelse(is.na(x), mean(x, na.rm = TRUE), x)) %>%
  mutate_if(is.factor, function(x) ifelse(is.na(x), as.numeric(names(table(x))[table(x) == max(table(x))]), x))
```

### iii. Build an initial Cox Proportional Hazards (CPH) model with covariates drug (trt) and bilirubin based on the survival object for sensor data, S2.
To construct an initial Cox Proportional Hazards (CPH) model with the covariates drug (trt) and bilirubin, we utilize the `coxph` function. This function requires a formula specifying the survival object and the covariates as the first argument, and a data frame containing the variables as the second argument.

```{r}
# I will use the default method
coxph_model <- coxph(S2 ~ pbcseq$trt + pbcseq$bili, data = pbcseq)

# Print the summary of the model
summary(coxph_model)
```

- The summary provides key insights into the coefficients, standard errors, z-values, p-values, and confidence intervals of the covariates.

- For the drug variable, the coefficient is -0.14, indicating a hazard ratio of 0.87 for D-penicillamine versus placebo. Given its p-value of 0.038, the drug’s effect is statistically significant at the 0.05 level.

- In contrast, the bilirubin variable has a coefficient of 0.08, suggesting a hazard ratio of 1.08 for a unit increase in bilirubin. With a p-value of less than 2e-16, the effect of bilirubin is also statistically significant at the 0.05 level.

- The summary further reveals the model’s log-likelihood, AIC, number of observations, number of events, and concordance index. The concordance index, a measure of the model’s predictive accuracy for survival times, is 0.735, indicating a moderate predictive ability. 

### iv. Use Stepwise Variable Selection starting from the initial model and AIC (Akaike Information Criterion). Make sure that the covariates drug (trt) and bilirubin are always included in the model. This is the “best fit” to your data.

- `stepAIC` from `MASS` does stepwise variable selection. Feed it your initial model. It goes both ways—forward and backward. Or just one way if you want.

- `scope` sets model formula boundaries. `update` tweaks the initial formula. Dot symbol stands for all other data variables. Plus and minus symbols add and remove variables.

- Use `I` to keep certain terms safe. Like 'drug' (trt) and 'bilirubin' covariates. Set the scope's lower bound to a model with just these two. Upper bound can be a model with all covariates.

- `trace` controls output verbosity. 1 is default for detailed output. 0 for none, 2 for concise. We'll use 1 here.

```{r}
# Load the MASS package for stepAIC function
library(MASS)

# Full model with all variables
full_model <- coxph(Surv(futime, ifelse(status == 0, 0, 1)) ~ ., data = pbcseq)

# Define a custom scope ensuring trt and bili are always in the model
scope <- list(lower = ~ trt + bili, upper = ~ .)

# Stepwise variable selection using AIC
best_model <- stepAIC(full_model, scope = scope, direction = "both", trace = F)
summary(best_model)
```

### v. Does the type of the drug used predict the survival of the patients?

**coef** : These are the coefficients of the model. They represent the change in the loghazard ratio for a one-unit increase in the corresponding predictor variable, holding allother predictors constant. For example, the coefficient for trt is -9.028e-02, which meansthat being treated with  placebo(compared to D-penicillamine) is associated with anincrease in the log hazard ratio of -9.028e-02. However, the p-value of the trt variable was greater than 0.05 and was not statistically significant. This means that the type of drug used does not predict patient survival.

### vi. Report the p-values for each of the covariates and the p-value for the overall significance of the model, provided by a X^2^ test.

- The p-values for each variable are shown below:
 - trt: 0.2088
 - age: 0.0169
 - sex: 2.21e-07 
 - day: < 2e-16 
 - hepato: 4.02e-06 
 - spiders: 0.0205
 - edema: 8.37e-10 
 - bili: < 2e-16 
 - chol: 0.0416
 - albumin: < 2e-16 
 - alk.phos: 2.88e-05
 - platelet: 4.00e-05 
 - stage: 2.41e-11 
- The overall significance p-value of the model is: <2e-16

### vii. Using the model you obtained from stepAIC Mf , construct two CPH models: one with all variables in Mf , and one with all variables excluding sex. This is to study the effect of the sex of the patients on their survival. Calculate the AICs of both of the models. Extract their AIC values and compare them. 

```{r}
# Model with all variables
aic_all <- AIC(best_model)

# Model excluding sex
model_no_sex <- coxph(S2 ~ trt + 
    age + day + hepato + spiders + edema + bili + chol + 
    albumin + alk.phos + platelet + stage, data = pbcseq)
aic_no_sex <- AIC(model_no_sex)

# Compare AICs
paste0("The AIC of model with all variables: ", round(aic_all, 2))
paste0("The AIC of model excluding sex: ", round(aic_no_sex, 2))
```

The output shows that the model without gender has a larger AIC than the model with all variables.

### viii. Plot the survival curve for each of the models (with and without sex) provided by the KM estimate calculated by survfit.

```{r fig.width = 10, fig.height = 8}
# KM estimate for model with all variables
km_all <- survfit(best_model)

# KM estimate for model excluding sex
km_no_sex <- survfit(model_no_sex)

# Plot survival curves
plot(km_all, main = "Survival Curves", xlab = "Time in days", ylab = "Survival probability", col = "blue")
lines(km_no_sex, col = "red")
legend("bottomleft", legend = c("All variables", "95% CI of model with all variables", "Excluding sex", "95% CI of model excluding sex"), col = c("blue", "blue", "red", "red"),lty = c(1, 2, 1, 2))
```

#  2. 50 points Extra Credit: Deep Survival Models
Using the package `survivalmodels` or any other package that you know build a deep learning model to replace the Cox Regression model. Try to make the deep model perform better than the original model in some sense. If you do not seem to get better results, justify what you see. Plot the survival functions based on your deep model.

```{r fig.width = 10, fig.height = 8, results = 'hide'}
# Install necessary packages
library(keras)
library(tensorflow)
library(dplyr)
data(pbc, package="survival")
pbcseq <- pbcseq %>%
  mutate_if(is.numeric, function(x) ifelse(is.na(x), mean(x, na.rm = TRUE), x)) %>%
  mutate_if(is.factor, function(x) ifelse(is.na(x), as.numeric(names(table(x))[table(x) == max(table(x))]), x))
pbcseq$alk.phos <- log(pbcseq$alk.phos)
pbcseq$platelet <- log(pbcseq$platelet)
S2 <- Surv(pbcseq$futime, ifelse(pbcseq$status == 0, 0, 1))
pbcseq$status <- ifelse(pbcseq$status == 0, 0, 1)

pbcseq$sex <- as.numeric(factor(pbcseq$sex))
# Prepare the data
x_train <- as.matrix(pbcseq[, -c(1,2,3)])  # Exclude case number, days, and status
y_train <- as.matrix(pbcseq$status)

# Build the model
model <- keras_model_sequential() %>%
  layer_dense(units = 32, activation = 'relu', input_shape = dim(x_train)[2]) %>%
  layer_dense(units = 1, activation = 'sigmoid')

# Compile the model
model %>% compile(
  optimizer = 'rmsprop',
  loss = 'binary_crossentropy',
  metrics = c('accuracy')
)

# Train the model
history <- model %>% fit(
  x_train, y_train,
  epochs = 100,
  batch_size = 512,
  validation_split = 0.2
)
```

```{r}
# Evaluate the model
results <- model %>% evaluate(x_train, y_train)
print(results)
```

```{r fig.width = 10, fig.height = 8}
# Load the packages
library(survival)
library(survminer)

# Fit a Cox proportional hazards model using the deep learning model predictions as a covariate
cox_fit <- coxph(S2 ~ model$predict(x_train), data = pbcseq)

# Plot the survival curves by the predicted risk groups (low, medium, high)
ggsurvplot(survfit(cox_fit), data = pbcseq,
           risk.table = TRUE, # show risk table
           pval = TRUE, # show p-value of log-rank test
           ggtheme = theme_bw(), # customize plot theme
           palette = c("#2E9FDF", "#E76BF3"), # custom color palette
           legend.title = "Predicted risk group", # change legend title
           xlab = "Time in days", # change x-axis label
           ylab = "Survival probability", # change y-axis label
           title = "Survival curves by deep learning model predictions" # change plot title
)

```

The deep learning model is not better than the best Cox proportional risk model obtained by stepwise regression because:

- The accuracy (Concordance) of the Cox proportional risk model is as high as 0.854, which is much higher than the `results[2]` of the deep learning model.
=-
- Almost all regression coefficients (coef) of the Cox proportional risk model are significant (Pr(>|z|) < 0.05), indicating that each of its variables has a significant effect on survival time, rather than random noise.

- All three tests (Likelihood ratio test, Wald test, Score test) for the Cox proportional risk model rejected the null hypothesis (regression coefficients of all variables are zero), indicating that it is a good model fit rather than a null model.